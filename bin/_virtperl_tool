#!/usr/bin/env perl

use strict;
use warnings;
use File::Path 2.00 qw(make_path remove_tree);
use File::Find;

my ($action, @args) = @ARGV;

if (!$action) {
    usage();
}

my $method = __PACKAGE__->can($action);

if (!$method) {
    usage();
}

$method->(@args);


sub create {
    my ($name) = @_;
    
    my $dir = "$ENV{PERL_VIRTPERL_ROOT}/$name";
    
    make_path("$dir/bin");
    make_path("$dir/lib/perl5");
    
    print "$name env created.\n\n";
}

sub list {
    my @envs = map { s:^.*/::; $_ } grep { -d } <"$ENV{PERL_VIRTPERL_ROOT}/*">;
    
    my $current = $ENV{PERL_VIRTPERL_CURRENT_ENV} || '';
    foreach my $env (@envs) {
        if ($env eq $current) {
            print "* $env\n";
        }
        else {
            print "  $env\n";
        }
    }
    
    print "\n";
}

sub remove {
    my ($name) = @_;
    my $dir = "$ENV{PERL_VIRTPERL_ROOT}/$name";
    
    my $current = $ENV{PERL_VIRTPERL_CURRENT_ENV} || '';
    
    if ($name eq $current) {
        die "Please change to another env before removing $name\n";
    }
    
    remove_tree($dir);
    
    print "$name removed\n\n"
    
}


sub mkcpanfile {
    my $current = $ENV{PERL_VIRTPERL_CURRENT_ENV};
    
    if (!$current) {
        die "An env must be in use for mkcpandir\n";
    }
    
    my %dists;
    my $vistor = sub {
        return unless -f && s/\.(tar\.gz|tar\.bz2?|tgz|zip)$//;
        my $mtime = (stat($_))[9];
        
        my ($name, $version) = m/(.*)-(.*)/;
        
        # if there's no other version, or this version is newer than the other.
        if (!$dists{$name} || $dists{$name}{mtime} < $mtime) {
            $dists{$name} = {
                name    => $name,
                version => $version,
                mtime   => $mtime,
            };
        }
    };
    
    find(
        $vistor,
        "$ENV{PERL_VIRTPERL_ROOT}/$current/dists"
    );
    
    foreach my $name (sort { $a cmp $b } keys %dists) {
        print "requires '$name', '$dists{$name}{version}';\n";
    }
}

sub usage {
    die "Usage: virtperl <create|use|remove|off|mkcpanfile>\n";
}

